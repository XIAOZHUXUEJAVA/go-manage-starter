.PHONY: help build run test test-unit test-integration test-integration-skip test-connection test-coverage clean dev dev-local run-test run-prod migrate seed docs fmt lint security docker-build docker-run docker-stop db-reset setup ci ci-full env-check

# Default target
help:
	@echo "Available commands:"
	@echo ""
	@echo "🏗️  Build & Run:"
	@echo "  build           - Build the application"
	@echo "  run             - Run the application"
	@echo "  dev             - Run in development mode (alias for dev-local)"
	@echo ""
	@echo "🚀 Environment-specific startup:"
	@echo "  dev-local       - Start in LOCAL development environment"
	@echo "  run-test        - Start in TEST environment"
	@echo "  run-prod        - Start in PRODUCTION environment"
	@echo ""
	@echo "🧪 Testing:"
	@echo "  test-connection - Test database and Redis connections (test env)"
	@echo "  test-connection-dev - Test connections (development env)"
	@echo "  test-connection-prod - Test connections (production env)"
	@echo "  test            - Run all tests"
	@echo "  test-unit       - Run unit tests only"
	@echo "  test-integration - Run integration tests only (requires database)"
	@echo "  test-integration-skip - Skip integration tests (short mode)"
	@echo "  test-coverage   - Run tests with coverage report"
	@echo ""
	@echo "🗄️  Database:"
	@echo "  migrate         - Run database migrations (development)"
	@echo "  migrate-test    - Run database migrations (test env)"
	@echo "  migrate-prod    - Run database migrations (production env)"
	@echo "  seed            - Seed database with sample data (development)"
	@echo "  seed-test       - Seed database (test env)"
	@echo "  seed-prod       - Seed database (production env)"
	@echo "  db-reset        - Reset database (migrate + seed)"
	@echo ""
	@echo "🔧 Environment:"
	@echo "  env-check       - Check required environment variables"
	@echo ""
	@echo "🛠️  Development Tools:"
	@echo "  docs            - Generate API documentation"
	@echo "  fmt             - Format code"
	@echo "  lint            - Lint code"
	@echo "  security        - Run security check"
	@echo ""
	@echo "🐳 Docker:"
	@echo "  docker-build    - Build Docker image"
	@echo "  docker-run      - Run with Docker Compose"
	@echo "  docker-stop     - Stop Docker Compose"
	@echo ""
	@echo "🔧 Utilities:"
	@echo "  clean           - Clean build artifacts"
	@echo "  setup           - Full development setup"
	@echo "  ci              - CI pipeline (without database)"
	@echo "  ci-full         - Full CI pipeline (with database)"

# Build the application
build:
	go build -o bin/server ./cmd/server

# Run the application
run: build
	./bin/server

# Development mode (alias for dev-local)
dev: dev-local

# Environment-specific startup commands
dev-local:
	@echo "🚀 Starting in LOCAL development environment..."
	ENVIRONMENT=development go run ./cmd/server

run-test: env-check-test
	@echo "🧪 Starting in TEST environment..."
	ENVIRONMENT=test go run ./cmd/server

run-prod: env-check-prod
	@echo "🏭 Starting in PRODUCTION environment..."
	ENVIRONMENT=production go run ./cmd/server

# Test database and Redis connections
test-connection-dev:
	@echo "🔌 Testing database and Redis connections (development)..."
	ENVIRONMENT=development go test ./test/connection/... -v

test-connection: env-check-test
	@echo "🔌 Testing database and Redis connections (test)..."
	ENVIRONMENT=test go test ./test/connection/... -v

test-connection-prod: env-check-prod
	@echo "🔌 Testing database and Redis connections (production)..."
	ENVIRONMENT=production go test ./test/connection/... -v

# Run all tests
test:
	go test ./... -v

# Run unit tests only (exclude integration tests)
test-unit:
	go test ./internal/... ./pkg/... -short -v

# Run integration tests only (requires database connection)
test-integration:
	@echo "Running integration tests (requires database)..."
	go test ./test/integration/... -v

# Skip integration tests (useful for CI without database)
test-integration-skip:
	@echo "Skipping integration tests (short mode)..."
	go test ./test/integration/... -v -short

# Run tests with coverage
test-coverage:
	go test ./... -coverprofile=coverage.out -v
	go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report generated: coverage.html"

# Run database migrations
migrate:
	@echo "🗄️ Running database migrations (development)..."
	ENVIRONMENT=development go run ./cmd/migrate

migrate-test: env-check-test
	@echo "🗄️ Running database migrations (test)..."
	ENVIRONMENT=test go run ./cmd/migrate

migrate-prod: env-check-prod
	@echo "🗄️ Running database migrations (production)..."
	ENVIRONMENT=production go run ./cmd/migrate

# Seed database with sample data
seed:
	@echo "🌱 Seeding database (development)..."
	ENVIRONMENT=development go run ./cmd/seed

seed-test: env-check-test
	@echo "🌱 Seeding database (test)..."
	ENVIRONMENT=test go run ./cmd/seed

seed-prod: env-check-prod
	@echo "🌱 Seeding database (production)..."
	ENVIRONMENT=production go run ./cmd/seed

# Clean build artifacts
clean:
	rm -rf bin/
	rm -f coverage.out coverage.html
	rm -f server.log

# Generate API documentation
docs:
	swag init -g ./cmd/server/main.go -o ./docs

# Format code
fmt:
	go fmt ./...

# Lint code (requires golangci-lint)
lint:
	golangci-lint run

# Run security check (requires gosec)
security:
	gosec ./...

# Docker commands
docker-build:
	docker build -t go-manage-starter .

docker-run:
	docker-compose up -d

docker-stop:
	docker-compose down

# Database commands
db-reset: migrate seed

# Full development setup
setup: test-connection migrate seed
	@echo "Development environment setup complete!"

# CI/CD pipeline simulation (without database)
ci: fmt lint security test-unit test-integration-skip
	@echo "CI pipeline completed successfully!"

# Environment variable checks
env-check:
	@echo "🔧 Checking environment variables..."
	@echo "Current environment: $${ENVIRONMENT:-development}"

env-check-test:
	@echo "🔧 Checking test environment variables..."
	@if [ -z "$${DB_USER}" ]; then echo "❌ DB_USER is not set"; exit 1; fi
	@if [ -z "$${DB_PASSWORD}" ]; then echo "❌ DB_PASSWORD is not set"; exit 1; fi
	@if [ -z "$${JWT_SECRET}" ]; then echo "❌ JWT_SECRET is not set"; exit 1; fi
	@echo "✅ All required test environment variables are set"

env-check-prod:
	@echo "🔧 Checking production environment variables..."
	@if [ -z "$${DB_USER}" ]; then echo "❌ DB_USER is not set"; exit 1; fi
	@if [ -z "$${DB_PASSWORD}" ]; then echo "❌ DB_PASSWORD is not set"; exit 1; fi
	@if [ -z "$${JWT_SECRET}" ]; then echo "❌ JWT_SECRET is not set"; exit 1; fi
	@if [ -z "$${REDIS_PASSWORD}" ]; then echo "❌ REDIS_PASSWORD is not set"; exit 1; fi
	@echo "✅ All required production environment variables are set"

# Helper commands for environment setup
env-setup-test:
	@echo "🔧 Setting up test environment..."
	@echo "Copy .env.test.example to .env.test and edit it:"
	@echo "  cp .env.test.example .env.test"
	@echo "  # Edit .env.test with your values"
	@echo "  source .env.test"
	@echo "  make test-connection"

env-setup-prod:
	@echo "🔧 Setting up production environment..."
	@echo "Copy .env.production.example to .env.production and edit it:"
	@echo "  cp .env.production.example .env.production"
	@echo "  # Edit .env.production with your values"
	@echo "  source .env.production"
	@echo "  make test-connection-prod"

# Full CI/CD pipeline (with database)
ci-full: fmt lint security test-unit test-integration
	@echo "Full CI pipeline completed successfully!"